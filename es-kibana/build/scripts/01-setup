#! /bin/sh

set -e
set -x
export DEBIAN_FRONTEND=noninteractive

##
## install dependency for elasticsearch
##
apt-get install --no-install-recommends -y default-jre-headless

##
## install elasticsearch and autostart elasticsearch
##
curl http://packages.elasticsearch.org/GPG-KEY-elasticsearch | apt-key add -
install -m 644 -o root -g root -p /build/etc/apt/sources.list.d/elasticsearch.list /etc/apt/sources.list.d/elasticsearch.list
etckeeper commit "apt: add elasticsearch apt-line"
apt-get update
apt-get install --no-install-recommends -y elasticsearch
insserv elasticsearch
etckeeper commit "enabled autostart eelasticsearch"

##
## download kibana (4.0.0 beta3), and extract to /opt/kibana
##
cd /tmp
curl -LO https://download.elasticsearch.org/kibana/kibana/kibana-4.0.0-BETA3.tar.gz
mkdir -p /opt/kibana
tar xf /tmp/kibana-4.0.0-BETA3.tar.gz -C /opt/kibana --strip-components=1
rm /tmp/kibana-4.0.0-BETA3.tar.gz

##
## add system user "kibana" to run kibana process
##
addgroup --system kibana
adduser --system --home /opt/kibana --shell /bin/false --no-create-home \
  --gecos 'kibana' --ingroup kibana --disabled-password \
  kibana
chown -R kibana:kibana /opt/kibana

##
## autostart supervisor
## (supervisor is already installed in baseimage)
##
insserv supervisor
etckeeper commit "autostart supervisor"

##
## add kibana to supervisor
##
install -m 644 -o root -g root -p /build/etc/supervisor/conf.d/kibana.conf /etc/supervisor/conf.d/kibana.conf
etckeeper commit "supervisor: add kibana"

