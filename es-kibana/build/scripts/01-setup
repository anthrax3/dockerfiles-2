#! /bin/sh

set -e
set -x
export DEBIAN_FRONTEND=noninteractive

##
## install deps
##
apt-get install --no-install-recommends -y default-jre-headless gnupg apt-transport-https

##
## install GPG key
##
curl -sSL https://packages.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
etckeeper commit "apt: Added GPG-KEY-elasticsearch"

##
## add apt-line and install elasticsearch
##
echo "deb https://packages.elastic.co/elasticsearch/2.x/debian stable main" > /etc/apt/sources.list.d/elasticsearch-2.x.list
etckeeper commit "apt: Added apt-line for elasticsearch"
apt-get update
apt-get install elasticsearch
update-rc.d elasticsearch defaults 95 10
etckeeper commit "enabled elasticsearch"
sed -i -e 's/^# network.host: .*$/network.host: 0.0.0.0/' /etc/elasticsearch/elasticsearch.yml
etckeeper commit "elasticsearch: bind 0.0.0.0"

##
## add apt-line and install kibana
##
echo "deb https://packages.elastic.co/kibana/4.6/debian stable main" > /etc/apt/sources.list.d/kibana.list
etckeeper commit "apt: Added apt-line for kibana"
apt-get update
apt-get install kibana
update-rc.d kibana defaults 95 10
etckeeper commit "enabled kibana"

