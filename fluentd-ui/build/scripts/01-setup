#! /bin/sh

set -e
set -x
export DEBIAN_FRONTEND=noninteractive

## install build-dependencies
apt-get install --no-install-recommends -y libcurl4-openssl-dev zip unzip

## put .gemrc
install -m 644 -o debian -g debian -p /build/home/debian/.gemrc /home/debian/.gemrc

## install fluentd-ui
sudo -u debian git clone https://github.com/fluent/fluentd-ui.git -b v0.1.4 /home/debian/fluentd-ui
sudo -u debian bash -c "cd /home/debian/fluentd-ui; bundle install --binstubs --without development test"

## install supervisor
apt-get install --no-install-recommends -y supervisor

## install supervisor config for fluentd-ui
install -m 644 -o root -g root -p /build/etc/supervisor/conf.d/fluentd-ui.conf /etc/supervisor/conf.d/fluentd-ui.conf

## install startup script for fluentd-ui
install -m 755 -o debian -g debian -p /build/home/debian/fluentd-ui/start_server.sh /home/debian/fluentd-ui/start_server.sh


