#! /bin/sh

set -e
set -x
export DEBIAN_FRONTEND=noninteractive

## intall packages
packages="build-essential direnv redis-tools"
apt-get install -y --no-install-recommends ${packages}

##
## install hubot
##
bash -l -c "npm install -g yo generator-hubot"
bash -l -c "ndenv rehash"

##
## install / configure hubot
##
bot_dir=/home/debian/hubot
sudo -u debian mkdir -p ${bot_dir}
cd ${bot_dir}

## configure shell environment variable
install -m 644 -o root -g root /build/etc/profile.d/hubot.sh /etc/profile.d/hubot.sh

## configure git
sudo -u debian -H bash -l -c "git config --global user.email debian@`hostname`"

## create bot
sudo -u debian -H bash -l -c "yo hubot --owner='minimum2scp <tyamada@minimum2scp.org>' --name='hubot' --adapter='slack' --description='test'"
sudo -u debian -H bash -l -c "git init . && git add . && git commit -m 'Initial commit'"

## rm old .node-version file
sudo -u debian -H bash -l -c "rm ./node_modules/hubot/.node-version ./node_modules/hubot-scripts/.node-version"

## remove hubot-heroku-keepalive
sudo -u debian -H bash -l -c "npm uninstall hubot-heroku-keepalive --save"
sudo -u debian -H bash -l -c "sed -i -s '/hubot-heroku-keepalive/d' external-scripts.json"
sudo -u debian -H bash -l -c "git commit -a -m 'remove hubot-heroku-keepalive'"

## add hubot start script for supervisor
install -m 755 -o debian -g debian -p /build/home/debian/hubot/start.sh /home/debian/hubot/start.sh
sudo -u debian -H bash -l -c "git add start.sh && git commit -m 'add start.sh for supervisor'"

## reset git config
sudo -u debian -H bash -l -c "git config --global --unset user.email"

##
## add hubot to supervisor
##
install -m 644 -o root -g root -p /build/etc/supervisor/conf.d/hubot.conf /etc/supervisor/conf.d/hubot.conf
etckeeper commit "supervisor: add hubot"

##
## autostart supervisor
## (supervisor is already installed in baseimage)
##
insserv supervisor
etckeeper commit "autostart supervisor"

